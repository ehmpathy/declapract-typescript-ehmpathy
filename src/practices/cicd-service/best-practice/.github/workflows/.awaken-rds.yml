name: .awaken

on:
  workflow_call:
    inputs:
      aws-region:
        type: string
        description: the aws region within which we should awaken the database
        required: true
    secrets:
      aws-account-id:
        description: the id of the account the credentials are expected to access
        required: true
      aws-access-key-id:
        description: required credentials to authenticate with aws
        required: true
      aws-secret-access-key:
        description: required credentials to authenticate with aws
        required: true

jobs:
  awaken:
    runs-on: ubuntu-24.04
    steps:
      - name: checkout
        uses: actions/checkout@v3

      - name: configure aws credentials
        if: "${{ inputs.aws-region != '' }}"
        uses: aws-actions/configure-aws-credentials@v1
        id: credentials
        with:
          aws-access-key-id: ${{ secrets.aws-access-key-id }}
          aws-secret-access-key: ${{ secrets.aws-secret-access-key }}
          aws-region: ${{ inputs.aws-region }}

      - name: confirm aws credentials
        if: "${{ inputs.aws-region != '' }}"
        run: |
          [[ ${{steps.credentials.outputs.aws-account-id}} != ${{ secrets.aws-account-id }} ]] \
            && echo 'wrong aws account' && exit 1 \
            || echo 'correct aws account';

      - name: open vpc tunnel
        run: |
          # open a tunnel into the vpc to be able to connect to the database
          bash .github/artifacts/use.vpc.tunnel.sh --daemon --with-deps-install --on-fail-logdump

      - name: await database capacity
        run: |
          # find the daemon info file (port-specific)
          INFO_FILES=($(ls /tmp/vpc-tunnel-*-info.json 2>/dev/null))
          if [ ${#INFO_FILES[@]} -eq 0 ]; then
            echo "✗ UnexpectedCodePathError: tunnel info file not found"
            exit 1
          elif [ ${#INFO_FILES[@]} -gt 1 ]; then
            echo "✗ UnexpectedCodePathError: multiple tunnel info files found: ${INFO_FILES[@]}"
            exit 1
          fi
          INFO_FILE="${INFO_FILES[0]}"
          echo "• using tunnel info: $INFO_FILE"

          # extract port and derive pid file name
          DB_PORT=$(jq -r '.local_port' "$INFO_FILE")
          PID_FILE="/tmp/vpc-tunnel-${DB_PORT}.pid"

          # verify tunnel is still alive
          if [ -f "$PID_FILE" ]; then
            TUNNEL_PID=$(cat "$PID_FILE")
            if kill -0 "$TUNNEL_PID" 2>/dev/null; then
              echo "✓ tunnel is running (pid: $TUNNEL_PID)"
            else
              echo "✗ tunnel process died unexpectedly"
              exit 1
            fi
          else
            echo "✗ tunnel pid file not found: $PID_FILE"
            exit 1
          fi

          # extract connection info from daemon info file
          DB_HOST=$(jq -r '.dns_name // "localhost"' "$INFO_FILE")
          echo "• database host: $DB_HOST"
          echo "• database port: $DB_PORT"

          # await for the capacity against that host
          bash .github/artifacts/use.rds.capacity.sh \
            --host "$DB_HOST" \
            --port "$DB_PORT" \
            --timeout 180

      - name: close vpc tunnel
        if: always()
        run: bash .github/artifacts/use.vpc.tunnel.sh --cleanup
