name: .deploy-sls

on:
  workflow_call:
    inputs:
      stage:
        type: string
        description: "the stage to deploy to"
        required: true
      github-environment:
        type: string
        description: "the github environment that the apply step will be executed in"
        required: true
      creds-aws-region:
        description: "creds for aws, specifies the region"
        required: true
        type: string
      creds-aws-role-arn:
        description: "creds for aws, specifies the role to assume via oidc"
        required: true
        type: string
      needs-vpn-for-acceptance:
        type: boolean
        description: whether or not this environment needs vpn access for acceptance tests
        required: false
        default: false
    secrets:
      pagerduty-integration-key:
        required: false
        description: enables sending pagerduty alarms on failure

permissions:
  id-token: write # required for oidc
  contents: read

jobs:
  install:
    uses: ./.github/workflows/.install.yml

  deploy:
    runs-on: ubuntu-24.04
    needs: [install]
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: set node-version
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"

      - name: configure aws credentials (oidc)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.creds-aws-role-arn }}
          aws-region: ${{ inputs.creds-aws-region }}

      - name: node-modules cache get
        uses: actions/cache/restore@v4
        with:
          path: ./node_modules
          key: ${{ needs.install.outputs.node-modules-cache-key }}
          fail-on-cache-miss: true

      - name: deploy
        run: STAGE=${{ inputs.stage }} DEPLOYER_NAME=$GITHUB_ACTOR npm run deploy

  assure:
    runs-on: ubuntu-24.04
    needs: [install, deploy]
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: set node-version
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"

      - name: configure aws credentials (oidc)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.creds-aws-role-arn }}
          aws-region: ${{ inputs.creds-aws-region }}

      - name: node-modules cache get
        uses: actions/cache/restore@v4
        with:
          path: ./node_modules
          key: ${{ needs.install.outputs.node-modules-cache-key }}
          fail-on-cache-miss: true

      - name: vpc:tunnel:open
        if: inputs.needs-vpn-for-acceptance
        run: STAGE=${{ inputs.stage }} .agent/repo=.this/skills/use.vpc.tunnel.ts

      - name: test:acceptance
        run: STAGE=${{ inputs.stage }} npm run test:acceptance

      - name: alarm on failure
        env:
          PAGERDUTY_INTEGRATION_KEY: ${{ secrets.pagerduty-integration-key }}
        if: failure() && env.PAGERDUTY_INTEGRATION_KEY
        uses: Entle/action-pagerduty-alert@0.2.0 # https://github.com/marketplace/actions/pagerduty-alert
        with:
          pagerduty-integration-key: "${{ secrets.pagerduty-integration-key }}"
          pagerduty-dedup-key: github_workflow_failed

  prune:
    runs-on: ubuntu-24.04
    needs: [install, deploy]
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: set node-version
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"

      - name: configure aws credentials (oidc)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.creds-aws-role-arn }}
          aws-region: ${{ inputs.creds-aws-region }}

      - name: node-modules cache get
        uses: actions/cache/restore@v4
        with:
          path: ./node_modules
          key: ${{ needs.install.outputs.node-modules-cache-key }}
          fail-on-cache-miss: true

      - name: prune
        run: STAGE=${{ inputs.stage }} DEPLOYER_NAME=$GITHUB_ACTOR npm run deploy:prune
