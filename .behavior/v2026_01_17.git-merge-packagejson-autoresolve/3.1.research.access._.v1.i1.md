# research: access requirements

## summary

the git merge package.json autoresolve feature requires access to:
1. **git merge driver interface** — the contract git uses to invoke custom merge drivers
2. **filesystem** — read/write access to the conflicted file and git config
3. **semver comparison library** — to determine which version is higher

no external apis, databases, or remote services are required. this is a purely local operation.

---

## 1. git merge driver interface

### what it is

git provides a mechanism for custom merge drivers via `.gitattributes` and git config. when a merge conflict occurs on a file matched by `.gitattributes`, git invokes the configured driver command instead of the default 3-way merge.

### contract

#### configuration structure [1]

```ini
[merge "drivername"]
    name = human-readable name
    driver = command %O %A %B %L %P
    recursive = binary
```

#### placeholder variables [1]

| placeholder | description |
|-------------|-------------|
| `%O` | common ancestor's version (temporary file) |
| `%A` | current version (temporary file) — **must be overwritten with result** |
| `%B` | other branch's version (temporary file) |
| `%L` | conflict marker size |
| `%P` | pathname where merged result will be stored |
| `%S` | conflict label for common ancestor |
| `%X` | conflict label for local head |
| `%Y` | conflict label for other head |

#### expected exit codes [1]

| exit code | result |
|-----------|--------|
| `0` | merge completed successfully with no conflicts |
| `1-128` | merge produced conflicts (file left in conflicted state) |
| `>128` | driver crashed; merge fails entirely |

> "The driver must overwrite the file named `%A` with the merge result." [1]

#### .gitattributes bind [1]

```
package.json merge=npm-package-merge
```

### citations

[1] git-scm.com/docs/gitattributes — "Custom merge drivers are configured in `.git/config` or `$HOME/.gitconfig`" ... "The `merge.*.driver` command uses these token replacements" ... "Return 0 for a clean merge" ... "The driver must overwrite the file named `%A` with the merge result"

---

## 2. filesystem access

### what it is

the merge driver receives paths to temporary files and must read/write them. no special filesystem apis beyond standard node.js `fs` module.

### contract

- read `%O` (base), `%A` (ours), `%B` (theirs) as utf-8 json
- write merged result to `%A`
- git handles the stage step automatically after driver returns 0

### best practices

- use synchronous file operations within the merge driver (git waits for completion)
- validate json before write to avoid corrupt package.json
- preserve original file encode format

---

## 3. semver comparison library

### what it is

the `semver` npm package is the de facto standard for semantic version comparison in node.js. it is the same library npm uses internally.

### contract (api) [2][3]

#### version comparison

```typescript
semver.gt(v1: string, v2: string): boolean   // v1 > v2
semver.lt(v1: string, v2: string): boolean   // v1 < v2
semver.eq(v1: string, v2: string): boolean   // v1 == v2
semver.compare(v1, v2): -1 | 0 | 1           // for sort
```

#### version coercion [3]

```typescript
semver.coerce(input: string): SemVer | null
// "attempts converting non-standard strings to valid semver"
// example: coerce('42.6.7.9.3-alpha') yields '42.6.7'
```

#### range operations [3]

```typescript
semver.satisfies(version, range): boolean
semver.maxSatisfying(versions[], range): string | null
semver.validRange(range): string | null
```

### pre-release handle [3]

> "Prerelease versions are excluded from ranges by default unless explicitly targeted. If a version has a prerelease tag (for example, 1.2.3-alpha.3) then it will only be allowed to satisfy ranges with matching major/minor/patch tuples that also contain prerelease specifications."

### best practices

- use `semver.valid()` before comparison to handle invalid version strings
- use `semver.coerce()` for lenient parse of non-standard versions
- when both versions are valid semver, `semver.gt()` determines the higher one
- when one or both are non-semver (e.g., "latest", "file:../local"), preserve as-is without comparison

### citations

[2] npmjs.com/package/semver — "semver is a widely-used library for semantic versioning in JavaScript"

[3] github.com/npm/node-semver — "`gt(v1, v2)`: Returns true if v1 is greater than v2" ... "`compare(v1, v2)`: Return 0 if v1 == v2, or 1 if v1 is greater, or -1 if v2 is greater" ... "`coerce(input)` attempts converting non-standard strings to valid semver"

---

## 4. prior art: npm-merge-driver

### what it is

official npm tool (now archived) for auto-resolve of package-lock.json conflicts.

### contract [4]

```bash
# installation
npx npm-merge-driver install --global

# manual git config
git config merge."npm-merge-driver".driver "npx npm-merge-driver merge %A %O %B %P"
```

### algorithm [4]

> "The driver executes npm's built-in conflict resolution capabilities without manual intervention."

the driver invokes `npm install` to regenerate the lockfile rather than merge it semantically.

### limitations

- archived august 2021, no longer maintained [4]
- only handles lockfiles, not package.json itself
- relies on npm install rather than semantic merge

### citations

[4] github.com/npm/npm-merge-driver — "The npm-merge-driver is a git merge driver designed to automatically resolve conflicts in npm-related lockfiles. The repository was archived on August 11, 2021"

---

## 5. prior art: merge-package.json

### what it is

npm package that merges package.json files via 3-way merge (local, base, remote).

### contract [5]

```typescript
const mergePackageJson = require('merge-package.json');
let merged = mergePackageJson(local, base, remote);
```

### algorithm claims [5]

- "Preserves ordering"
- "Follows SemVer"
- "Uses best guess to resolve conflicts"

> note: the documentation provides no explicit details about the specific algorithm implementation or how conflicts are resolved beyond "best guess" [5]

### citations

[5] github.com/kellyselden/merge-package.json — "Preserves ordering" ... "Follows SemVer" ... "Uses best guess to resolve conflicts"

---

## 6. prior art: parse-conflict-json

### what it is

npm package that parses json that contains git merge conflict markers.

### contract [6]

```typescript
parseConflictJSON(text, reviver?, prefer?)
// prefer defaults to 'ours', set to 'theirs' to prefer other side
```

### algorithm [6]

> "It parses the conflicted file into 3 pieces: ours, theirs, and parent. It then gets the diff from parent to ours and applies each change of that diff to theirs."

> "If `prefer` is set to `theirs`, then the values of theirs and ours are switched in the resolver function."

> "When conflicting changes cannot be applied (e.g., one side converts an object to a primitive while the other modifies fields), the resolver prioritizes the preferred version's entire object at that path location."

### citations

[6] github.com/npm/parse-conflict-json — "It parses the conflicted file into 3 pieces: ours, theirs, and parent. It then gets the diff from parent to ours and applies each change of that diff to theirs" ... "If either side of the conflict is invalid JSON, then an error is thrown for that"

---

## 7. built-in git merge drivers

### available drivers [1]

| driver | behavior |
|--------|----------|
| `text` | standard 3-way merge with conflict markers (`<<<<<<<`, `=======`, `>>>>>>>`) |
| `binary` | keeps current branch version, marks file conflicted |
| `union` | takes lines from both versions without markers (may produce invalid json) |

> "union: 3-way merge for text files that takes lines from both versions instead of conflict markers. Results in merged content without explicit conflicts, but lines may appear in random order. Requires user verification." [1]

the `union` driver is unsuitable for json as it does not understand json structure.

---

## 8. npm built-in conflict resolution

### what it is

npm 5.7.0+ can resolve package-lock.json conflicts automatically.

### contract [7]

```bash
# after you fix package.json conflicts manually
npm install [--package-lock-only]
```

> "As of npm@5.7.0, these conflicts can be resolved by manually fixing any package.json conflicts, and then running `npm install [--package-lock-only]` again. npm will automatically resolve any conflicts for you and write a merged package lock that includes all the dependencies from both branches in a reasonable tree." [7]

### limitations

- only resolves package-lock.json, not package.json
- requires package.json conflicts to be resolved first

### citations

[7] npmjs.com/about-semantic-versioning — "Occasionally, two separate npm install will create package locks that cause merge conflicts in source control systems. As of npm@5.7.0, these conflicts can be resolved by manually fixing any package.json conflicts, and then running `npm install [--package-lock-only]` again"

---

## recommended approach

based on the research:

1. **use git merge driver interface** — bind via `.gitattributes` for automatic invocation
2. **use `semver` package** — for robust version comparison with pre-release and coercion support
3. **implement custom 3-way merge logic** — since tools that exist either:
   - only handle lockfiles (npm-merge-driver)
   - are unmaintained (npm-merge-driver archived)
   - lack documented algorithms (merge-package.json)
   - don't implement the specific rules in our criteria (version pick, removal intent)

4. **consider `parse-conflict-json`** — useful if we need to handle files already in conflicted state (manual invocation mode)

---

## sources

1. [gitattributes documentation](https://git-scm.com/docs/gitattributes) — git custom merge driver specification
2. [semver on npm](https://www.npmjs.com/package/semver) — version comparison library
3. [node-semver on github](https://github.com/npm/node-semver) — semver api documentation
4. [npm-merge-driver on github](https://github.com/npm/npm-merge-driver) — archived npm merge driver
5. [merge-package.json on github](https://github.com/kellyselden/merge-package.json) — package.json merge library
6. [parse-conflict-json on github](https://github.com/npm/parse-conflict-json) — conflict marker parser
7. [npm semantic versioning docs](https://docs.npmjs.com/about-semantic-versioning/) — npm conflict resolution
