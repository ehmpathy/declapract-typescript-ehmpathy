# blueprint: acceptance/ -> blackbox/

## .what

rename the `acceptance/` test directory to `blackbox/` across all practices to clarify that acceptance tests should be blackbox tests against external caller contracts.

## .why

- the term "blackbox" makes the testing philosophy explicit
- blackbox tests interact only through public contracts (APIs, CLIs, SDKs)
- reduces confusion about what acceptance tests should and should not access
- aligns terminology with industry-standard testing vocabulary

## .scope

### files affected

| practice | file | change |
|----------|------|--------|
| `tests-service` | `best-practice/acceptance/` | rename to `blackbox/` |
| `tests-service` | `best-practice/acceptance/**/*.acceptance.test.ts.declapract.ts` | move to `blackbox/` |
| `tests-service` | `best-practice/acceptance/lambdas/*.acceptance.test.ts.declapract.ts` | move to `blackbox/lambdas/` |
| `tests` | `bad-practices/old-acceptance-test-utils/` | update paths `acceptance/` → `blackbox/` |
| `tests` | `bad-practices/old-acceptance-test-utils-2/` | update paths `acceptance/` → `blackbox/` |
| `tests` | `bad-practices/old-acceptance-test-utils-3/` | update paths `acceptance/` → `blackbox/` |
| `tests` | new bad-practice `old-acceptance-dir-location/` | migrate files from `acceptance/` → `blackbox/` |

### file extension unchanged

the `.acceptance.test.ts` extension remains — only the directory changes:
- before: `acceptance/*.acceptance.test.ts`
- after: `blackbox/*.acceptance.test.ts`

---

## .implementation

### 1. update tests-service best-practice

#### 1.1 rename directory structure

```
src/practices/tests-service/best-practice/
├── blackbox/                                          # renamed from acceptance/
│   ├── **/*.acceptance.test.ts.declapract.ts          # moved
│   └── lambdas/
│       └── *.acceptance.test.ts.declapract.ts         # moved
```

#### 1.2 update import paths in declapract files

in `blackbox/lambdas/*.acceptance.test.ts.declapract.ts`:
```typescript
// update relative import path
"import { locally } from '../environment';" // stays same - relative path unchanged
"import { stage } from '../../src/utils/environment';" // stays same
```

### 2. add bad-practice: old-acceptance-dir-location

create migration practice to move files from `acceptance/` to `blackbox/`.

#### 2.1 directory structure

```
src/practices/tests/bad-practices/old-acceptance-dir-location/
├── acceptance/**/*.acceptance.test.ts.declapract.ts      # detect files in old location
├── acceptance/**/*.acceptance.test.ts.declapract.test.ts # unit test for fix
├── acceptance/**/*.ts.declapract.ts                      # detect any ts files in acceptance/
├── acceptance/**/*.ts.declapract.test.ts                 # unit test for fix
└── .declapract.readme.md                                 # explain the migration
```

#### 2.2 check logic

```typescript
// acceptance/**/*.acceptance.test.ts.declapract.ts
import { FileCheckType, type FileFixFunction } from 'declapract';

export const check = FileCheckType.EXISTS; // if files exist in acceptance/, flag as bad practice

export const fix: FileFixFunction = (contents, context) => {
  // move from acceptance/ to blackbox/
  const newPath = context.relativeFilePath.replace(
    /^acceptance\//,
    'blackbox/',
  );
  return {
    contents: contents ?? null,
    relativeFilePath: newPath,
  };
};
```

#### 2.3 unit test

```typescript
// acceptance/**/*.acceptance.test.ts.declapract.test.ts
import { fix } from './*.acceptance.test.ts.declapract';

describe('old-acceptance-dir-location acceptance test files', () => {
  it('should move files from acceptance/ to blackbox/', async () => {
    const contents = `import { something } from './utils';`;
    const context = {
      relativeFilePath: 'acceptance/lambdas/myLambda.acceptance.test.ts',
    } as any;

    const result = await fix(contents, context);

    expect(result.relativeFilePath).toBe('blackbox/lambdas/myLambda.acceptance.test.ts');
    expect(result.contents).toBe(contents); // contents unchanged
  });

  it('should move nested acceptance test files', async () => {
    const contents = `describe('test', () => {});`;
    const context = {
      relativeFilePath: 'acceptance/nested/deep/test.acceptance.test.ts',
    } as any;

    const result = await fix(contents, context);

    expect(result.relativeFilePath).toBe('blackbox/nested/deep/test.acceptance.test.ts');
  });
});
```

### 3. add bad-practice: old-acceptance-import-paths

create migration to update import paths that reference `acceptance/`.

#### 3.1 directory structure

```
src/practices/tests/bad-practices/old-acceptance-import-paths/
├── **/*.ts.declapract.ts           # detect imports referencing acceptance/
├── **/*.ts.declapract.test.ts      # unit test
└── .declapract.readme.md
```

#### 3.2 check and fix logic

```typescript
// **/*.ts.declapract.ts
import type { FileCheckFunction, FileFixFunction } from 'declapract';

export const check: FileCheckFunction = (contents) => {
  // match imports that reference acceptance/ directory
  if (contents?.match(/from ['"]\.\.?\/.*acceptance\//)) return; // matches bad practice
  if (contents?.match(/from ['"]acceptance\//)) return; // matches bad practice
  throw new Error('does not match bad practice');
};

export const fix: FileFixFunction = (contents) => {
  if (!contents) return {};
  return {
    contents: contents
      .replace(/(['"])(.*)\/acceptance\//g, '$1$2/blackbox/')
      .replace(/(['"])acceptance\//g, '$1blackbox/'),
  };
};
```

#### 3.3 unit test

```typescript
// **/*.ts.declapract.test.ts
import { check, fix } from './*.ts.declapract';

describe('old-acceptance-import-paths', () => {
  it('should match files with acceptance/ imports', () => {
    const contents = `import { locally } from '../acceptance/environment';`;
    expect(() => check(contents, {} as any)).not.toThrow();
  });

  it('should not match files without acceptance/ imports', () => {
    const contents = `import { locally } from '../blackbox/environment';`;
    expect(() => check(contents, {} as any)).toThrow('does not match bad practice');
  });

  it('should replace acceptance/ with blackbox/ in imports', async () => {
    const contents = `import { locally } from '../acceptance/environment';`;
    const { contents: fixed } = await fix(contents, {} as any);

    expect(fixed).toBe(`import { locally } from '../blackbox/environment';`);
  });

  it('should handle multiple imports', async () => {
    const contents = `
import { locally } from '../acceptance/environment';
import { something } from '../../acceptance/utils';
    `.trim();

    const { contents: fixed } = await fix(contents, {} as any);

    expect(fixed).toContain('../blackbox/environment');
    expect(fixed).toContain('../../blackbox/utils');
    expect(fixed).not.toContain('acceptance');
  });
});
```

### 4. update existing bad-practices

update the following existing bad-practices to reference `blackbox/` instead of `acceptance/`:

#### 4.1 old-acceptance-test-utils

```
src/practices/tests/bad-practices/old-acceptance-test-utils/
├── blackbox/_utils/...              # renamed from acceptance/
└── blackbox/lambdas/...             # renamed from acceptance/
```

#### 4.2 old-acceptance-test-utils-2

```
src/practices/tests/bad-practices/old-acceptance-test-utils-2/
└── blackbox/lambdas/...             # renamed from acceptance/
```

#### 4.3 old-acceptance-test-utils-3

```
src/practices/tests/bad-practices/old-acceptance-test-utils-3/
├── blackbox/_utils/...              # renamed from acceptance/
└── blackbox/lambdas/...             # renamed from acceptance/
```

---

## .test coverage

### unit tests

| file | test |
|------|------|
| `old-acceptance-dir-location/**/*.declapract.ts` | verify path rewrite `acceptance/` → `blackbox/` |
| `old-acceptance-import-paths/**/*.declapract.ts` | verify import path replacement |
| existing bad-practices with updated paths | verify fixes still work |

### integration tests

| scenario | validation |
|----------|------------|
| apply practice to repo with `acceptance/` dir | files moved to `blackbox/` |
| apply practice to repo with acceptance imports | imports updated to blackbox |

### acceptance tests

| scenario | validation |
|----------|------------|
| run `declapract plan` on target repo | detects `acceptance/` as violation |
| run `declapract apply` on target repo | migrates to `blackbox/` successfully |
| run tests after migration | all tests pass with new paths |

---

## .execution order

1. **update tests-service best-practice**
   - rename `acceptance/` → `blackbox/` directory
   - update any internal references

2. **add old-acceptance-dir-location bad-practice**
   - create check for files in `acceptance/`
   - create fix to move to `blackbox/`
   - add unit tests

3. **add old-acceptance-import-paths bad-practice**
   - create check for imports referencing `acceptance/`
   - create fix to update imports
   - add unit tests

4. **update existing bad-practices**
   - rename `acceptance/` → `blackbox/` in directory structure
   - update any hardcoded path references

5. **run full test suite**
   - `npm run test:types`
   - `npm run test:lint`
   - `npm run test:unit`
   - `npm run test:integration` (if applicable)

---

## .files to create/modify

### new files

```
src/practices/tests/bad-practices/old-acceptance-dir-location/
├── acceptance/**/*.acceptance.test.ts.declapract.ts
├── acceptance/**/*.acceptance.test.ts.declapract.test.ts
├── acceptance/**/*.ts.declapract.ts
├── acceptance/**/*.ts.declapract.test.ts
└── .declapract.readme.md

src/practices/tests/bad-practices/old-acceptance-import-paths/
├── **/*.ts.declapract.ts
├── **/*.ts.declapract.test.ts
└── .declapract.readme.md
```

### files to rename/move

```
# tests-service best-practice
mv src/practices/tests-service/best-practice/acceptance/ \
   src/practices/tests-service/best-practice/blackbox/

# tests bad-practices (update internal paths)
# old-acceptance-test-utils: acceptance/ → blackbox/
# old-acceptance-test-utils-2: acceptance/ → blackbox/
# old-acceptance-test-utils-3: acceptance/ → blackbox/
```

### files to modify

- any `.declapract.ts` files with hardcoded `acceptance/` references
- any import paths within the practices that reference `acceptance/`

---

## .notes

- the `.acceptance.test.ts` file extension is preserved — it communicates the test type
- the `blackbox/` directory name communicates the testing philosophy
- both new bad-practices should run during migration to ensure complete cleanup
- existing repos will be migrated automatically when they run `declapract apply`
