# roadmap: git-merge-packagejson-autoresolve

## legend

- `[ ]` = not started
- `[~]` = in progress
- `[x]` = complete
- `[!]` = blocked
- `depends:` = must complete before this step
- `verify:` = how to confirm step is complete
- `accepts:` = blackbox criteria satisfied by this step

---

## phase 0: scaffold

### 0.1 create package directory structure

- [ ] create `src/_topublish/git-merge-packagejson/`
- [ ] create `src/_topublish/git-merge-packagejson/src/`
- [ ] create `src/_topublish/git-merge-packagejson/src/domain.objects/`
- [ ] create `src/_topublish/git-merge-packagejson/src/domain.operations/`
- [ ] create `src/_topublish/git-merge-packagejson/src/contract/commands/`
- [ ] create `src/_topublish/git-merge-packagejson/bin/`

**depends:** none

**verify:**
```bash
ls -la src/_topublish/git-merge-packagejson/
# expect: src/, bin/ directories exist
```

### 0.2 create package.json for collocated package

- [ ] create `src/_topublish/git-merge-packagejson/package.json`
  - name: `git-merge-packagejson`
  - bin: `git-merge-packagejson` → `./bin/git-merge-packagejson.js`
  - dependencies: `semver`, `helpful-errors`
  - devDependencies: `test-fns`

**depends:** 0.1

**verify:**
```bash
cat src/_topublish/git-merge-packagejson/package.json | jq '.name'
# expect: "git-merge-packagejson"
```

### 0.3 create tsconfig.json for collocated package

- [ ] create `src/_topublish/git-merge-packagejson/tsconfig.json`
  - extends root tsconfig
  - include: `src/**/*`

**depends:** 0.1

**verify:**
```bash
cat src/_topublish/git-merge-packagejson/tsconfig.json | jq '.extends'
# expect: path to root tsconfig
```

---

## phase 1: core logic (leaf operations)

### 1.1 implement stripVersionQualifier

- [ ] create `src/_topublish/git-merge-packagejson/src/domain.operations/stripVersionQualifier.ts`
- [ ] create `src/_topublish/git-merge-packagejson/src/domain.operations/stripVersionQualifier.test.ts`

**depends:** 0.1

**accepts:** boundary condition — qualifiers stripped for comparison, winner keeps original

**verify:**
```bash
npm run test:unit -- stripVersionQualifier
# expect: all tests pass
```

**test cases:**
- `^1.2.3` → base: `1.2.3`, original: `^1.2.3`
- `~1.2.3` → base: `1.2.3`, original: `~1.2.3`
- `>=1.2.3` → base: `1.2.3`, original: `>=1.2.3`
- `1.2.3` → base: `1.2.3`, original: `1.2.3`
- `latest` → base: `latest`, original: `latest` (non-semver passthrough)
- `file:../local` → base: `file:../local`, original: `file:../local`
- `workspace:^` → base: `workspace:^`, original: `workspace:^`

### 1.2 implement compareVersions

- [ ] create `src/_topublish/git-merge-packagejson/src/domain.operations/compareVersions.ts`
- [ ] create `src/_topublish/git-merge-packagejson/src/domain.operations/compareVersions.test.ts`

**depends:** 1.1

**accepts:**
- usecase.1 — higher semver version selected
- boundary — pre-release versions follow semver precedence

**verify:**
```bash
npm run test:unit -- compareVersions
# expect: all tests pass
```

**test cases:**
- `1.2.3` vs `1.2.4` → `b-higher`
- `2.0.0` vs `1.9.9` → `a-higher`
- `1.0.0` vs `1.0.0` → `equal`
- `1.0.0` vs `1.0.0-beta.1` → `a-higher` (stable > pre-release)
- `1.0.0-alpha` vs `1.0.0-beta` → `b-higher`
- `latest` vs `1.0.0` → `incomparable`
- `file:../a` vs `file:../b` → `incomparable`

### 1.3 implement detectRemovalIntent

- [ ] create `src/_topublish/git-merge-packagejson/src/domain.operations/detectRemovalIntent.ts`
- [ ] create `src/_topublish/git-merge-packagejson/src/domain.operations/detectRemovalIntent.test.ts`

**depends:** 0.1

**accepts:**
- usecase.3 — removal intent honored

**verify:**
```bash
npm run test:unit -- detectRemovalIntent
# expect: all tests pass
```

**test cases:**
- dep in base + ours, not in theirs → removed in theirs
- dep in base + theirs, not in ours → removed in ours
- dep in base, not in ours or theirs → removed in both
- dep not in base, in ours → added in ours (not removal)
- dep not in base, in theirs → added in theirs (not removal)
- dep in all three → no removal

### 1.4 implement parsePackageJson

- [ ] create `src/_topublish/git-merge-packagejson/src/domain.operations/parsePackageJson.ts`
- [ ] create `src/_topublish/git-merge-packagejson/src/domain.operations/parsePackageJson.test.ts`

**depends:** 0.2 (needs helpful-errors)

**accepts:**
- usecase.6 — invalid json raises clear error with branch identifier

**verify:**
```bash
npm run test:unit -- parsePackageJson
# expect: all tests pass
```

**test cases:**
- valid json → parsed object
- invalid json in ours → error: "invalid json in 'ours' branch: ..."
- invalid json in theirs → error: "invalid json in 'theirs' branch: ..."
- empty string → error or empty object (decide)

### 1.5 implement mergeDependencySection

- [ ] create `src/_topublish/git-merge-packagejson/src/domain.operations/mergeDependencySection.ts`
- [ ] create `src/_topublish/git-merge-packagejson/src/domain.operations/mergeDependencySection.test.ts`

**depends:** 1.1, 1.2, 1.3

**accepts:**
- usecase.1 — version conflicts resolve to higher
- usecase.2 — additions unioned
- usecase.3 — removals honored over updates

**verify:**
```bash
npm run test:unit -- mergeDependencySection
# expect: all tests pass
```

**test cases:**
- same dep, different versions → higher wins
- dep added in ours only → included
- dep added in theirs only → included
- dep added in both with same version → included once
- dep added in both with different versions → higher wins
- dep removed in ours, updated in theirs → removed (removal wins)
- dep removed in theirs, updated in ours → removed (removal wins)
- dep removed in both → removed
- empty section in one branch → other branch's section used

---

## phase 2: orchestration

### 2.1 implement mergePackageJson

- [ ] create `src/_topublish/git-merge-packagejson/src/domain.operations/mergePackageJson.ts`
- [ ] create `src/_topublish/git-merge-packagejson/src/domain.operations/mergePackageJson.test.ts`
- [ ] create `src/_topublish/git-merge-packagejson/src/domain.operations/mergePackageJson.integration.test.ts`

**depends:** 1.4, 1.5

**accepts:**
- usecase.4 — all dependency sections work independently
- usecase.5 — non-dependency fields left with conflict markers

**verify:**
```bash
npm run test:unit -- mergePackageJson
npm run test:integration -- mergePackageJson
# expect: all tests pass
```

**test cases:**
- dependencies section only → merged
- devDependencies section only → merged
- all four sections with conflicts → each merged independently
- non-dep field conflict (scripts) → conflict markers preserved
- non-dep field conflict (version) → conflict markers preserved
- mixed: dep sections clean, scripts conflict → deps merged, scripts marked
- result is valid json

### 2.2 implement merge command (cli entrypoint)

- [ ] create `src/_topublish/git-merge-packagejson/src/contract/commands/merge.ts`
- [ ] create `src/_topublish/git-merge-packagejson/src/contract/commands/merge.integration.test.ts`
- [ ] create `src/_topublish/git-merge-packagejson/bin/git-merge-packagejson.js`

**depends:** 2.1

**accepts:**
- usecase.7 — tool can be invoked directly on conflicted file

**verify:**
```bash
npm run test:integration -- merge.integration
# expect: all tests pass
```

**test cases:**
- receives %O %A %B %P, writes result to %A
- exit 0 when fully resolved
- exit 1 when non-dep conflicts remain
- exit >128 on error (invalid json)

### 2.3 implement install command

- [ ] add `--install` flag to cli
- [ ] configures git: `merge.npm-packagejson-merge.driver`
- [ ] create test for install command

**depends:** 2.2

**accepts:**
- usecase.7 — users can configure via install command

**verify:**
```bash
# after install runs:
git config --get merge.npm-packagejson-merge.driver
# expect: "npx git-merge-packagejson %O %A %B %P"
```

---

## phase 3: acceptance tests

### 3.1 acceptance tests for usecase.1 (version conflicts)

- [ ] create `src/_topublish/git-merge-packagejson/src/acceptance/usecase1.acceptance.test.ts`

**depends:** 2.1

**accepts:**
- usecase.1 — all scenarios

**verify:**
```bash
npm run test:acceptance -- usecase1
# expect: all tests pass
```

**scenarios:**
- same dep updated in both branches → higher version
- multiple deps with conflicts → each resolved independently
- pre-release vs stable → stable wins
- caret vs tilde → higher base version wins, qualifier preserved

### 3.2 acceptance tests for usecase.2 (union additions)

- [ ] create `src/_topublish/git-merge-packagejson/src/acceptance/usecase2.acceptance.test.ts`

**depends:** 2.1

**accepts:**
- usecase.2 — all scenarios

**verify:**
```bash
npm run test:acceptance -- usecase2
# expect: all tests pass
```

**scenarios:**
- dep added in one branch, absent in base → preserved
- different deps added in each branch → both appear

### 3.3 acceptance tests for usecase.3 (removal intent)

- [ ] create `src/_topublish/git-merge-packagejson/src/acceptance/usecase3.acceptance.test.ts`

**depends:** 2.1

**accepts:**
- usecase.3 — all scenarios

**verify:**
```bash
npm run test:acceptance -- usecase3
# expect: all tests pass
```

**scenarios:**
- dep removed in one branch → removed in result
- dep removed in one branch, updated in other → removed (removal wins)

### 3.4 acceptance tests for usecase.4 (dependency sections)

- [ ] create `src/_topublish/git-merge-packagejson/src/acceptance/usecase4.acceptance.test.ts`

**depends:** 2.1

**accepts:**
- usecase.4 — all scenarios

**verify:**
```bash
npm run test:acceptance -- usecase4
# expect: all tests pass
```

**scenarios:**
- conflicts in dependencies, devDependencies, peerDependencies, optionalDependencies
- dep moved from devDependencies to dependencies → no duplication

### 3.5 acceptance tests for usecase.5 (scope limitation)

- [ ] create `src/_topublish/git-merge-packagejson/src/acceptance/usecase5.acceptance.test.ts`

**depends:** 2.1

**accepts:**
- usecase.5 — all scenarios

**verify:**
```bash
npm run test:acceptance -- usecase5
# expect: all tests pass
```

**scenarios:**
- non-dep field conflict → conflict markers preserved
- dep sections resolved, non-dep conflicted → partial resolution
- only non-dep conflicts → exit 1 (conflicts remain)

### 3.6 acceptance tests for usecase.6 (edge cases)

- [ ] create `src/_topublish/git-merge-packagejson/src/acceptance/usecase6.acceptance.test.ts`

**depends:** 2.1

**accepts:**
- usecase.6 — all scenarios

**verify:**
```bash
npm run test:acceptance -- usecase6
# expect: all tests pass
```

**scenarios:**
- invalid json in branch → clear error
- `latest` version → preserved as-is
- `file:../local` version → preserved as-is
- `workspace:^` version → preserved as-is

### 3.7 acceptance tests for usecase.7 (git integration)

- [ ] create `src/_topublish/git-merge-packagejson/src/acceptance/usecase7.acceptance.test.ts`

**depends:** 2.2, 2.3

**accepts:**
- usecase.7 — all scenarios

**verify:**
```bash
npm run test:acceptance -- usecase7
# expect: all tests pass
```

**scenarios:**
- .gitattributes configured → driver invoked on merge
- direct invocation on conflicted file → works
- no conflict state → clear message

---

## phase 4: declapract practice

### 4.1 create practice directory

- [ ] create `src/practices/git-merge-packagejson/`
- [ ] create `src/practices/git-merge-packagejson/best-practice/`
- [ ] create `src/practices/git-merge-packagejson/.declapract.readme.md`

**depends:** 2.3

**verify:**
```bash
ls src/practices/git-merge-packagejson/
# expect: best-practice/, .declapract.readme.md
```

### 4.2 create .gitattributes practice file

- [ ] create `src/practices/git-merge-packagejson/best-practice/.gitattributes`
- [ ] create `src/practices/git-merge-packagejson/best-practice/.gitattributes.declapract.ts`
- [ ] create `src/practices/git-merge-packagejson/best-practice/.gitattributes.declapract.test.ts`

**depends:** 4.1

**verify:**
```bash
npm run test:unit -- .gitattributes.declapract
# expect: all tests pass
```

### 4.3 create package.json practice file

- [ ] create `src/practices/git-merge-packagejson/best-practice/package.json`
- [ ] create `src/practices/git-merge-packagejson/best-practice/package.json.declapract.ts`

**depends:** 4.1

**verify:**
```bash
cat src/practices/git-merge-packagejson/best-practice/package.json
# expect: devDependencies includes git-merge-packagejson
```

### 4.4 add practice to useCases.yml

- [ ] add `git-merge-packagejson` to `typescript-project` practices list

**depends:** 4.2, 4.3

**verify:**
```bash
grep "git-merge-packagejson" src/useCases.yml
# expect: found in typescript-project practices
npm run build && npm run test:validate
# expect: passes
```

---

## phase 5: documentation and publish prep

### 5.1 create readme for package

- [ ] create `src/_topublish/git-merge-packagejson/readme.md`
  - installation instructions
  - usage examples
  - git config setup via `--install`

**depends:** 2.3

**verify:**
```bash
cat src/_topublish/git-merge-packagejson/readme.md | head -20
# expect: clear installation and usage instructions
```

### 5.2 create index.ts exports

- [ ] create `src/_topublish/git-merge-packagejson/src/index.ts`
  - export `mergePackageJson` for programmatic use
  - export types

**depends:** 2.1

**verify:**
```bash
grep "export" src/_topublish/git-merge-packagejson/src/index.ts
# expect: mergePackageJson exported
```

### 5.3 final validation

- [ ] all unit tests pass
- [ ] all integration tests pass
- [ ] all acceptance tests pass
- [ ] declapract validates
- [ ] package can be built

**depends:** 3.1-3.7, 4.4

**verify:**
```bash
npm run test
npm run build
npm run test:validate
# expect: all pass
```

---

## dependency graph

```
phase 0 (scaffold)
    │
    ├── 0.1 ─────────────────────────────────────┐
    │       │                                     │
    │       ├── 0.2 (package.json)               │
    │       │                                     │
    │       └── 0.3 (tsconfig)                   │
    │                                             │
phase 1 (core logic)                             │
    │                                             │
    ├── 1.1 (stripVersionQualifier) ◄────────────┘
    │       │
    │       └── 1.2 (compareVersions) ◄── 1.1
    │
    ├── 1.3 (detectRemovalIntent) ◄── 0.1
    │
    ├── 1.4 (parsePackageJson) ◄── 0.2
    │
    └── 1.5 (mergeDependencySection) ◄── 1.1, 1.2, 1.3
            │
phase 2 (orchestration)
            │
    ├── 2.1 (mergePackageJson) ◄── 1.4, 1.5
    │       │
    │       └── 2.2 (merge command) ◄── 2.1
    │               │
    │               └── 2.3 (install command) ◄── 2.2
    │
phase 3 (acceptance)
    │
    ├── 3.1-3.6 ◄── 2.1
    │
    └── 3.7 ◄── 2.2, 2.3
            │
phase 4 (declapract)
            │
    ├── 4.1 ◄── 2.3
    │       │
    │       ├── 4.2 ◄── 4.1
    │       │
    │       └── 4.3 ◄── 4.1
    │               │
    │               └── 4.4 ◄── 4.2, 4.3
    │
phase 5 (docs + publish)
    │
    ├── 5.1 ◄── 2.3
    │
    ├── 5.2 ◄── 2.1
    │
    └── 5.3 ◄── 3.1-3.7, 4.4
```

---

## summary

| phase | steps | key deliverable |
|-------|-------|-----------------|
| 0 | 0.1-0.3 | package scaffold |
| 1 | 1.1-1.5 | core merge logic with unit tests |
| 2 | 2.1-2.3 | cli entrypoint with integration tests |
| 3 | 3.1-3.7 | acceptance tests for all usecases |
| 4 | 4.1-4.4 | declapract practice |
| 5 | 5.1-5.3 | documentation and final validation |

**total steps:** 22

**critical path:** 0.1 → 1.1 → 1.2 → 1.5 → 2.1 → 2.2 → 2.3 → 3.7 → 4.4 → 5.3
