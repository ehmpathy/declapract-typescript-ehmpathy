# Execution: please-release-action

## Status: PHASE 1-2 COMPLETE, PHASE 3-4 PENDING USER VALIDATION

---

## Phase 1: Implement Core Action

### 1.1 Create composite action skeleton
- [x] create action.yml with inputs (github-token, commit-message, commit-sha, repository)
- [x] create action.yml with outputs (action, version, pr-number)
- [x] define 4 step stubs with correct `if` conditions and `env` vars

### 1.2 Implement step 1: cutta tag
- [x] detect release commit via `chore(release):` prefix
- [x] extract version from commit message
- [x] failfast if version not found
- [x] find merged release PR by title search
- [x] failfast if release PR not found
- [x] failfast if release PR missing `release={version}` label
- [x] create and push git tag
- [x] create github release with `--generate-notes`
- [x] comment on release PR with release url
- [x] extract referenced PRs from body and comment on each
- [x] output `did-cutta=true/false`

### 1.3 Implement step 2: crunch future semver
- [x] get latest tag via `git describe --tags --abbrev=0`
- [x] early return `v0.1.0` if no tags exist
- [x] get commits since tag
- [x] detect `break:` commits for major bump
- [x] detect `feat:` commits for minor bump
- [x] default to patch bump
- [x] compute next version string
- [x] output `next-version`

### 1.4 Implement step 3: crunch future changelog
- [x] group commits by type (breaks, feats, fixes)
- [x] format header with compare link and date
- [x] format each commit as tree with date, PR link (if present), commit link
- [x] output changelog string

### 1.5 Implement step 4: upsert release pr
- [x] failfast if package.json not found
- [x] find existing release PR by `purpose=release` label
- [x] if exists: fetch branch, update package.json, commit, push, update PR metadata
- [x] if not exists: create branch, update package.json, commit, push, create PR
- [x] apply labels: `purpose=release`, `release={version}`

### 1.6 Update release.yml workflow
- [x] get github app token first (before checkout)
- [x] checkout with token for git push auth
- [x] call composite action with all inputs

---

## Phase 2: Implement Supporting Changes

### 2.1 Update commitlint config
- [x] add `break` to type-enum
- [x] add rule to forbid `!` prefix via `subject-exclamation-mark`

### 2.2 Add bad practice for changelog.md
- [x] create check that matches if changelog.md exists
- [x] create fix that returns `{ contents: null }` to delete file

---

## Phase 3: Validate

### 3.1 Test in this repo
- [ ] copy action and workflow to this repo's .github
- [ ] merge a feat commit, verify release PR created
- [ ] merge another fix commit, verify release PR updated
- [ ] merge the release PR, verify tag and release created
- [ ] verify comments added to release PR and referenced PRs

### 3.2 Test edge cases
- [ ] test first release (no existing tags)
- [ ] test break: commit (major bump)
- [ ] test mixed commit types (precedence)
- [ ] test commit without PR reference

---

## Phase 4: Roll Out

### 4.1 Run declapract apply
- [ ] run `npx declapract apply` against ehmpathy repos
- [ ] verify composite action copied to each repo
- [ ] verify workflow updated in each repo
- [ ] verify changelog.md flagged for deletion

---

## Execution Log

### 2025-12-20

**Phase 1: Implement Core Action**

- Created composite action at `src/practices/cicd-common/best-practice/.github/actions/please-release/action.yml`
  - Inputs: github-token, commit-message, commit-sha, repository
  - Outputs: action, version, pr-number
  - Step 1: cutta tag (release commit detection, tag creation, release creation, PR comments)
  - Step 2: crunch future semver (version bump computation)
  - Step 3: crunch future changelog (tree-format changelog with PR/commit links)
  - Step 4: upsert release pr (create or update release PR)
  - Step 5: aggregate outputs

- Updated `src/practices/cicd-common/best-practice/.github/workflows/release.yml`
  - Removed release-please-action dependency
  - Now uses collocated composite action
  - Token generation moved before checkout for git push auth

**Phase 2: Implement Supporting Changes**

- Updated `src/practices/conventional-commits/best-practice/commitlint.config.js`
  - Added `break` to type-enum for breaking changes
  - Added `subject-exclamation-mark: [2, 'never']` to forbid `!` prefix

- Created bad practice at `src/practices/cicd-common/bad-practices/has-changelog-file/`
  - `changelog.md.declapract.ts` - flags and deletes changelog.md
  - `changelog.md.declapract.test.ts` - unit tests

**Validation**

- `npm run test:types` - PASS
- `npm run test:unit` - PASS (2 tests)
- `npm run test:lint` - PASS

**Next Steps**

Phase 3 and 4 require user validation:
- Copy action to this repo's .github and test with real commits
- Run declapract apply against target repos

---

## Files Created/Modified

### Created
- `src/practices/cicd-common/best-practice/.github/actions/please-release/action.yml`
- `src/practices/cicd-common/bad-practices/has-changelog-file/changelog.md.declapract.ts`
- `src/practices/cicd-common/bad-practices/has-changelog-file/changelog.md.declapract.test.ts`

### Modified
- `src/practices/cicd-common/best-practice/.github/workflows/release.yml`
- `src/practices/conventional-commits/best-practice/commitlint.config.js`
