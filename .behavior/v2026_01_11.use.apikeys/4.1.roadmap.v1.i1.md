# roadmap: use.apikeys.json integration with cicd workflows

## overview

this roadmap implements the blueprint at `3.3.blueprint.v1.i1.md` in ordered, verifiable steps.

**goal:** enable declapract to check+fix that CI/CD workflows correctly declare and forward apikey secrets based on `use.apikeys.json`.

---

## phase 0: relocate apikey files from tests to cicd-common

### 0.1 move use.apikeys.json to cicd-common

- [ ] copy `src/practices/tests/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.json` to `src/practices/cicd-common/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.json`

**acceptance criteria:**
- file exists at new location with identical content

**verification:**
```sh
diff src/practices/tests/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.json \
     src/practices/cicd-common/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.json
# expect: no diff
```

### 0.2 move use.apikeys.sh to cicd-common

- [ ] copy `src/practices/tests/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.sh` to `src/practices/cicd-common/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.sh`

**acceptance criteria:**
- file exists at new location with identical content

**verification:**
```sh
diff src/practices/tests/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.sh \
     src/practices/cicd-common/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.sh
# expect: no diff
```

### 0.3 move use.apikeys.json.declapract.ts to cicd-common

- [ ] copy `src/practices/tests/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.json.declapract.ts` to `src/practices/cicd-common/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.json.declapract.ts`

**acceptance criteria:**
- file exists at new location

**verification:**
```sh
ls src/practices/cicd-common/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.json.declapract.ts
# expect: file exists
```

### 0.4 move use.apikeys.sh.declapract.ts to cicd-common

- [ ] copy `src/practices/tests/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.sh.declapract.ts` to `src/practices/cicd-common/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.sh.declapract.ts`

**acceptance criteria:**
- file exists at new location

**verification:**
```sh
ls src/practices/cicd-common/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.sh.declapract.ts
# expect: file exists
```

### 0.5 delete old files from tests practice

- [ ] delete `src/practices/tests/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.json`
- [ ] delete `src/practices/tests/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.json.declapract.ts`
- [ ] delete `src/practices/tests/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.sh`
- [ ] delete `src/practices/tests/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.sh.declapract.ts`

**acceptance criteria:**
- files no longer exist at old location

**verification:**
```sh
ls src/practices/tests/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.* 2>&1
# expect: No such file or directory
```

### 0.6 create bad-practice to remove old location

- [ ] create `src/practices/tests/bad-practices/old-apikeys-location/.agent/repo=.this/role=any/skills/use.apikeys.json.declapract.ts`
- [ ] create `src/practices/tests/bad-practices/old-apikeys-location/.agent/repo=.this/role=any/skills/use.apikeys.json.declapract.test.ts`
- [ ] create `src/practices/tests/bad-practices/old-apikeys-location/.agent/repo=.this/role=any/skills/use.apikeys.sh.declapract.ts`
- [ ] create `src/practices/tests/bad-practices/old-apikeys-location/.agent/repo=.this/role=any/skills/use.apikeys.sh.declapract.test.ts`

**acceptance criteria:**
- bad-practice files exist with `check = FileCheckType.EXISTS` and `fix` returning `{ contents: null }`
- unit tests pass

**verification:**
```sh
npm run test:unit -- old-apikeys-location
# expect: all tests pass
```

### 0.7 verify phase 0 complete

**acceptance criteria:**
- build passes
- unit tests pass

**verification:**
```sh
npm run build && npm run test:unit
# expect: success
```

---

## phase 1: domain utilities

**depends on:** phase 0 complete

### 1.1 create readUseApikeysConfig utility

- [ ] create `src/utils/readUseApikeysConfig.ts` with:
  - reads `.agent/repo=.this/role=any/skills/use.apikeys.json` from project root
  - returns parsed `UseApikeysConfig` or null if not found
  - handles malformed json gracefully

**acceptance criteria:**
- function exists and is exported
- follows `(input, context?) => Promise<T>` pattern

**verification:**
```sh
grep -l "readUseApikeysConfig" src/utils/readUseApikeysConfig.ts
# expect: file found with export
```

### 1.2 create readUseApikeysConfig unit tests

- [ ] create `src/utils/readUseApikeysConfig.test.ts` with:
  - test: returns parsed config when file exists
  - test: returns null when file does not exist
  - test: handles malformed json gracefully

**acceptance criteria:**
- all unit tests pass

**verification:**
```sh
npm run test:unit -- readUseApikeysConfig.test.ts
# expect: 3 tests pass
```

### 1.3 verify phase 1 complete

**acceptance criteria:**
- build passes
- all unit tests pass

**verification:**
```sh
npm run build && npm run test:unit
# expect: success
```

---

## phase 2: best-practice for use.apikeys.json existence

**depends on:** phase 1 complete

### 2.1 update use.apikeys.json.declapract.ts with fix function

- [ ] update `src/practices/cicd-common/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.json.declapract.ts`:
  - `check = FileCheckType.EXISTS`
  - `fix` creates default structure `{ apikeys: { required: [] } }` when file doesn't exist
  - `fix` preserves content when file already exists

**acceptance criteria:**
- check detects when file doesn't exist
- fix creates valid default json structure

**verification:**
```sh
grep -A10 "fix:" src/practices/cicd-common/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.json.declapract.ts
# expect: fix function with JSON.stringify
```

### 2.2 create use.apikeys.json.declapract.test.ts

- [ ] create `src/practices/cicd-common/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.json.declapract.test.ts` with:
  - test: fix creates default structure when file doesn't exist
  - test: fix preserves content when file already exists

**acceptance criteria:**
- all unit tests pass

**verification:**
```sh
npm run test:unit -- use.apikeys.json.declapract.test.ts
# expect: 2 tests pass
```

### 2.3 verify phase 2 complete

**acceptance criteria:**
- build passes
- all unit tests pass

**verification:**
```sh
npm run build && npm run test:unit
# expect: success
```

---

## phase 3: best-practice for .test.yml secrets declaration

**depends on:** phase 2 complete

### 3.1 create buildExpectedContent helper for .test.yml

- [ ] create `src/practices/cicd-common/best-practice/.github/workflows/.test.yml.declapract.ts` with:
  - `buildExpectedContent({ template, apikeys })` function
  - inserts secrets declaration block after `workflow_call` inputs
  - inserts env block to `test-integration` job

**acceptance criteria:**
- function transforms template + apikeys into expected content
- handles case when no apikeys (returns template unchanged)

**verification:**
```sh
grep -l "buildExpectedContent" src/practices/cicd-common/best-practice/.github/workflows/.test.yml.declapract.ts
# expect: file found with function
```

### 3.2 create check function for .test.yml

- [ ] add `check` function to `.test.yml.declapract.ts`:
  - reads apikeys from project via `readUseApikeysConfig`
  - builds expected content from template + apikeys
  - throws if `contents === expected` (file passes)
  - returns if contents differ (bad practice detected)

**acceptance criteria:**
- check function follows declapract contract
- uses `context.declaredFileContents` for template

**verification:**
```sh
grep -A5 "export const check" src/practices/cicd-common/best-practice/.github/workflows/.test.yml.declapract.ts
# expect: FileCheckFunction with readUseApikeysConfig
```

### 3.3 create fix function for .test.yml

- [ ] add `fix` function to `.test.yml.declapract.ts`:
  - builds expected content from template + apikeys
  - returns `{ contents: expected }`

**acceptance criteria:**
- fix function follows declapract contract
- returns expected content (full overwrite)

**verification:**
```sh
grep -A5 "export const fix" src/practices/cicd-common/best-practice/.github/workflows/.test.yml.declapract.ts
# expect: FileFixFunction returning { contents: expected }
```

### 3.4 create .test.yml.declapract.test.ts

- [ ] create `src/practices/cicd-common/best-practice/.github/workflows/.test.yml.declapract.test.ts` with:
  - test: buildExpectedContent adds secrets declaration to workflow_call
  - test: buildExpectedContent adds multiple secrets
  - test: buildExpectedContent adds env vars to test-integration job
  - test: buildExpectedContent returns template unchanged when no apikeys
  - test: check throws when contents match expected
  - test: check returns when contents differ from expected
  - test: fix returns expected content

**acceptance criteria:**
- all unit tests pass
- tests use inline snapshots for expected output

**verification:**
```sh
npm run test:unit -- .test.yml.declapract.test.ts
# expect: 7 tests pass
```

### 3.5 verify phase 3 complete

**acceptance criteria:**
- build passes
- all unit tests pass

**verification:**
```sh
npm run build && npm run test:unit
# expect: success
```

---

## phase 4: best-practice for workflow secrets forwarding

**depends on:** phase 3 complete

### 4.1 create test.yml.declapract.ts

- [ ] create `src/practices/cicd-common/best-practice/.github/workflows/test.yml.declapract.ts` with:
  - `buildExpectedContent({ template, apikeys })` for secrets forwarding
  - `check` and `fix` functions following same pattern as .test.yml

**acceptance criteria:**
- adds `secrets:` block to jobs that call `.test.yml`
- handles multiple jobs calling `.test.yml`

**verification:**
```sh
grep -l "buildExpectedContent" src/practices/cicd-common/best-practice/.github/workflows/test.yml.declapract.ts
# expect: file found
```

### 4.2 create test.yml.declapract.test.ts

- [ ] create `src/practices/cicd-common/best-practice/.github/workflows/test.yml.declapract.test.ts` with:
  - test: buildExpectedContent adds secrets forwarding
  - test: buildExpectedContent adds multiple secrets
  - test: buildExpectedContent handles multiple jobs calling .test.yml

**acceptance criteria:**
- all unit tests pass

**verification:**
```sh
npm run test:unit -- test.yml.declapract.test.ts
# expect: 3+ tests pass
```

### 4.3 create publish.yml.declapract.ts

- [ ] create `src/practices/cicd-package/best-practice/.github/workflows/publish.yml.declapract.ts`
  - same pattern as test.yml.declapract.ts

**acceptance criteria:**
- adds secrets forwarding to jobs that call `.test.yml`

**verification:**
```sh
grep -l "buildExpectedContent" src/practices/cicd-package/best-practice/.github/workflows/publish.yml.declapract.ts
# expect: file found
```

### 4.4 create publish.yml.declapract.test.ts

- [ ] create `src/practices/cicd-package/best-practice/.github/workflows/publish.yml.declapract.test.ts`

**acceptance criteria:**
- all unit tests pass

**verification:**
```sh
npm run test:unit -- publish.yml.declapract.test.ts
# expect: tests pass
```

### 4.5 create deploy.yml.declapract.ts

- [ ] create `src/practices/cicd-service/best-practice/.github/workflows/deploy.yml.declapract.ts`
  - same pattern as test.yml.declapract.ts

**acceptance criteria:**
- adds secrets forwarding to jobs that call `.test.yml`

**verification:**
```sh
grep -l "buildExpectedContent" src/practices/cicd-service/best-practice/.github/workflows/deploy.yml.declapract.ts
# expect: file found
```

### 4.6 create deploy.yml.declapract.test.ts

- [ ] create `src/practices/cicd-service/best-practice/.github/workflows/deploy.yml.declapract.test.ts`

**acceptance criteria:**
- all unit tests pass

**verification:**
```sh
npm run test:unit -- deploy.yml.declapract.test.ts
# expect: tests pass
```

### 4.7 verify phase 4 complete

**acceptance criteria:**
- build passes
- all unit tests pass

**verification:**
```sh
npm run build && npm run test:unit
# expect: success
```

---

## phase 5: integration verification

**depends on:** phase 4 complete

### 5.1 run full test suite

- [ ] run all unit tests
- [ ] run all integration tests (if applicable)

**acceptance criteria:**
- all tests pass
- no regressions in existing practices

**verification:**
```sh
npm run test:unit && npm run test:integration
# expect: all pass
```

### 5.2 verify declapract check works

- [ ] run `npx declapract check` against a test repo with `use.apikeys.json` containing `["ANTHROPIC_API_KEY"]`

**acceptance criteria:**
- declapract detects when .test.yml is missing secrets declaration
- declapract detects when test.yml is missing secrets forwarding

**verification:**
```sh
npx declapract check --project-root /path/to/test/repo
# expect: violations reported for missing secrets
```

### 5.3 verify declapract fix works

- [ ] run `npx declapract fix` against a test repo

**acceptance criteria:**
- .test.yml gains `secrets:` declaration for each apikey
- .test.yml gains `env:` block in test-integration job
- test.yml gains `secrets:` forwarding for each apikey
- use.apikeys.json created if it didn't exist

**verification:**
```sh
npx declapract fix --project-root /path/to/test/repo
git diff /path/to/test/repo/.github/workflows/
# expect: secrets and env blocks added
```

### 5.4 verify idempotency

- [ ] run `npx declapract fix` twice in a row

**acceptance criteria:**
- second run produces no changes
- `npx declapract check` passes after fix

**verification:**
```sh
npx declapract fix --project-root /path/to/test/repo
npx declapract fix --project-root /path/to/test/repo
git status /path/to/test/repo
# expect: nothing to commit, working tree clean
```

### 5.5 verify migration from old location

- [ ] for a repo with apikeys files in old `tests` practice location:
  - run `npx declapract fix`
  - verify old files are deleted
  - verify new files are created in `cicd-common` location

**acceptance criteria:**
- old location files removed
- new location files created
- single declapract run handles full migration

**verification:**
```sh
npx declapract fix --project-root /path/to/test/repo
ls /path/to/test/repo/.agent/repo=.this/role=any/skills/use.apikeys.*
# expect: files exist
```

---

## summary checklist

### phase 0: relocate apikey files
- [ ] 0.1 move use.apikeys.json to cicd-common
- [ ] 0.2 move use.apikeys.sh to cicd-common
- [ ] 0.3 move use.apikeys.json.declapract.ts to cicd-common
- [ ] 0.4 move use.apikeys.sh.declapract.ts to cicd-common
- [ ] 0.5 delete old files from tests practice
- [ ] 0.6 create bad-practice to remove old location
- [ ] 0.7 verify phase 0 complete

### phase 1: domain utilities
- [ ] 1.1 create readUseApikeysConfig utility
- [ ] 1.2 create readUseApikeysConfig unit tests
- [ ] 1.3 verify phase 1 complete

### phase 2: best-practice for use.apikeys.json existence
- [ ] 2.1 update use.apikeys.json.declapract.ts with fix function
- [ ] 2.2 create use.apikeys.json.declapract.test.ts
- [ ] 2.3 verify phase 2 complete

### phase 3: best-practice for .test.yml secrets declaration
- [ ] 3.1 create buildExpectedContent helper for .test.yml
- [ ] 3.2 create check function for .test.yml
- [ ] 3.3 create fix function for .test.yml
- [ ] 3.4 create .test.yml.declapract.test.ts
- [ ] 3.5 verify phase 3 complete

### phase 4: best-practice for workflow secrets forwarding
- [ ] 4.1 create test.yml.declapract.ts
- [ ] 4.2 create test.yml.declapract.test.ts
- [ ] 4.3 create publish.yml.declapract.ts
- [ ] 4.4 create publish.yml.declapract.test.ts
- [ ] 4.5 create deploy.yml.declapract.ts
- [ ] 4.6 create deploy.yml.declapract.test.ts
- [ ] 4.7 verify phase 4 complete

### phase 5: integration verification
- [ ] 5.1 run full test suite
- [ ] 5.2 verify declapract check works
- [ ] 5.3 verify declapract fix works
- [ ] 5.4 verify idempotency
- [ ] 5.5 verify migration from old location

---

## final acceptance criteria

the implementation is complete when:

1. **use.apikeys.json creation**: `npx declapract fix` creates `use.apikeys.json` if it doesn't exist
2. **.test.yml secrets declaration**: `npx declapract fix` adds secrets declaration to `.test.yml` for each key in `use.apikeys.json`
3. **workflow secrets forwarding**: `npx declapract fix` adds secrets forwarding to `test.yml`, `publish.yml`, and `deploy.yml`
4. **env injection**: `.test.yml` `test-integration` job has env vars for each secret
5. **idempotency**: running fix twice produces no changes
6. **migration**: old location files are cleaned up automatically
7. **all tests pass**: `npm run build && npm run test:unit && npm run test:integration`
