# Research: RDS Data API Type Coercion Behavior

## Discovery (2025-11-29)

Integration tests against LocalStack's RDS Data API emulator passed, but acceptance tests against real AWS Aurora (dev environment) failed with type mismatch errors.

## The Errors

### Error 1: Without typeHint (real Aurora)
```
ERROR: operator does not exist: uuid = text
Hint: No operator matches the given name and argument types. You might need to add explicit type casts.
```

### Error 2: With automatic typeHint on UUID-like strings
```
ERROR: operator does not exist: character varying = uuid
Hint: No operator matches the given name and argument types. You might need to add explicit type casts.
```

This occurred when a UUID-formatted string (e.g., `abe83377-72ef-4ebf-9b35-812bf013e35a`) was stored in a `varchar` column (slug), not a `uuid` column.

## Root Cause Analysis

### pg Driver Behavior

The pg driver uses PostgreSQL's **Extended Query Protocol**, which sends parameters separately from the SQL statement. Key characteristics:

1. Parameters are sent as text without explicit type information
2. PostgreSQL determines the appropriate type based on the **context** (the column type being compared)
3. When PostgreSQL sees `WHERE uuid_column = $1`, it knows `$1` should be coerced to `uuid`
4. This "context-based coercion" is automatic and transparent

### RDS Data API Behavior

The RDS Data API is an HTTP-based wrapper with different semantics:

1. Parameters arrive with their types **already determined** at the API level
2. String values arrive as `text`/`varchar` type
3. PostgreSQL's strict type system doesn't have a built-in `uuid = text` operator
4. Without explicit `typeHint`, comparison fails with type mismatch

### LocalStack Emulator Behavior

LocalStack's `koxudaxi/local-data-api` uses JDBC under the hood:

1. JDBC **does** perform automatic type inference (similar to pg driver context-based coercion)
2. UUID-formatted strings are recognized and bound as UUID type
3. This creates false positives - tests pass locally but fail on real AWS

## The Dilemma

We initially added automatic UUID type hints based on string format:

```typescript
const getTypeHint = (value: unknown): 'UUID' | undefined => {
  if (typeof value === 'string' && UUID_REGEX.test(value)) return 'UUID';
  return undefined;
};
```

**Problem:** A UUID-formatted string might be stored in a `varchar` column (e.g., `slug` field). Adding `typeHint: 'UUID'` causes PostgreSQL to treat it as UUID type, which can't compare against `varchar`.

**Removing typeHint entirely:** Breaks queries against actual `uuid` columns on real Aurora.

## Solution: Explicit SQL Casts

Use explicit SQL casts (`::uuid`) for UUID columns. This works universally:

```sql
-- Before (fails on RDS Data API without typeHint)
WHERE home_service.uuid = :uuid

-- After (works everywhere)
WHERE home_service.uuid = :uuid::uuid
```

### Why This Works

1. **pg driver:** Ignores the cast since it already handles coercion correctly
2. **RDS Data API:** The cast tells PostgreSQL to convert the text parameter to UUID
3. **varchar columns:** Don't get the `::uuid` cast, so UUID-formatted strings remain as text
4. **Explicit:** The type expectation is documented in the SQL itself

## Do NOT Use Automatic typeHint Detection

Auto-detecting UUID format and adding `typeHint` is fundamentally flawed because:

1. You cannot know from the **value** whether it should be a UUID or text
2. The **column type** determines the correct casting, not the value format
3. Values like slugs, external IDs, or tokens may be UUID-formatted but stored as text

## Industry Confirmation

This is a known issue across ORMs using RDS Data API:

- [Drizzle ORM issue #2583](https://github.com/drizzle-team/drizzle-orm/issues/2583) - "Drizzle Studio uses ORM under the hood for queries, and they are working to add Aurora use cases for multiple data types"
- [TypeORM Aurora Data API driver issue #81](https://github.com/ArsenyYankovsky/typeorm-aurora-data-api-driver/issues/81) - "An earlier UUID hack using regex pattern matching was removed because implicit casting was considered unsafe"
- [TypeORM Aurora Data API driver issue #85](https://github.com/ArsenyYankovsky/typeorm-aurora-data-api-driver/issues/85) - Similar type mismatch issues
- [Stack Overflow](https://stackoverflow.com/questions/79346581/casting-custom-types-with-rds-data-api-and-aurora-postgres) - Recommends explicit casts or custom operators

## Action Items

1. âœ… Remove automatic `typeHint` detection based on string format from `getDatabaseConnectionViaRdsDataApi.ts`
2. Add `::uuid` casts to all SQL queries that compare against UUID columns
3. Consider building a strict local emulator (see `3.3.blueprint.v1.i1.md`) to catch these issues in integration tests

## Files Affected

All DAO files with UUID column comparisons need `::uuid` casts:
- `src/data/dao/homeServiceDao/findByUuid.ts`
- `src/data/dao/leadCaptureFormDao/findByUuid.ts`
- `src/data/dao/leadCaptureFormInfoSectionDao/findByUuid.ts`
- Any other queries comparing against `uuid` type columns
