# Domain Research: please-release-action

## Domain Objects

### Entities

#### 1. Commit
A git commit with conventional commit message structure.

**Properties** (from conventional-commits-parser [1]):
```typescript
{
  type: string;        // 'feat', 'fix', 'break', 'chore', etc.
  scope: string | null; // optional scope in parentheses
  subject: string;     // commit description
  header: string;      // full first line
  body: string | null; // detailed description
  footer: string | null;
  notes: Array<{ title: string; text: string }>; // breaking changes
  references: Array<{ action: string; issue: string; raw: string }>;
}
```

> "The commit message should be structured as follows: `<type>[optional scope]: <description>`" [2]

#### 2. Tag
A git tag representing a release version.

**Properties**:
- `name`: string (e.g., "v1.2.3")
- `commit_sha`: string
- `created_at`: timestamp

> "Releases are based on Git tags, which mark a specific point in your repository's history." [3]

#### 3. Release
A GitHub release associated with a tag.

**Properties** (from GitHub API [3]):
- `tag_name`: string (required)
- `target_commitish`: string
- `name`: string
- `body`: string
- `draft`: boolean
- `prerelease`: boolean
- `html_url`: string

#### 4. PullRequest
A GitHub pull request for release coordination.

**Properties** (from GitHub API [4]):
- `number`: number
- `title`: string
- `body`: string
- `state`: 'open' | 'closed' | 'merged'
- `head`: { ref: string; sha: string }
- `base`: { ref: string }
- `labels`: Array<{ name: string }>

> "Pull requests are a type of issue. Any actions that are available in both pull requests and issues... are handled by the REST API to manage issues." [4]

#### 5. Comment
A comment on a GitHub issue/PR.

**Properties** (from GitHub API [5]):
- `id`: number
- `body`: string
- `created_at`: timestamp
- `user`: { login: string }

#### 6. Label
A label attached to a PR for metadata tracking.

**Properties** (from GitHub API [6]):
- `name`: string (e.g., "purpose=release", "uptilCommit=abc123")
- `color`: string
- `description`: string

### Events

#### 1. PushEvent
Triggered when commits are pushed to a branch.

> "The `push` event activates when you commit or tag changes" [7]

**Context available**:
- `github.event.head_commit.message` - the commit message [8]
- `github.sha` - tip commit SHA [7]
- `github.ref` - updated reference (branch/tag)

#### 2. WorkflowTrigger
The GitHub Actions workflow run context.

**Context available**:
- `github.repository` - owner/repo
- `github.event` - full event payload
- `github.token` - authentication token

### Literals

#### 1. SemVer
Semantic version string in format `vMAJOR.MINOR.PATCH`.

> "A normal version number MUST take the form X.Y.Z where X, Y, and Z are non-negative integers" [9]

#### 2. CommitType
Enumeration of conventional commit types:
- `feat` - new feature (MINOR bump)
- `fix` - bug fix (PATCH bump)
- `break` - breaking change (MAJOR bump)
- `chore`, `doc`, `refactor`, `test` - other (PATCH bump)

> "fix type commits should be translated to PATCH releases. feat type commits should be translated to MINOR releases." [2]

#### 3. ReleaseTitle
Format: `"chore(release): v{version} ðŸŽ‰"`

#### 4. ReleaseComment
Format: `"ðŸŒŠ released at {release-url}"`

---

## Domain Operations

### getOne

#### getLatestTag()
```bash
git describe --tags --abbrev=0
```
> "This can be done with a simple Bash one-liner: `git log $(git describe --tags --abbrev=0)..HEAD`" [10]

#### getOpenReleasePR()
```
GET /repos/{owner}/{repo}/pulls?state=open&labels=purpose=release
```
> "Lists pull requests in a specified repository" [4]

#### getPRByNumber(number)
```
GET /repos/{owner}/{repo}/pulls/{pull_number}
```

#### getReleaseByTag(tag)
```
GET /repos/{owner}/{repo}/releases/tags/{tag}
```
> "Getting a Release by Tag Name... URL Pattern: `/repos/{owner}/{repo}/releases/tags/{tag}`" [3]

### getAll

#### getCommitsSinceTag(tag)
```bash
git log {tag}..HEAD --pretty=format:"%H %s"
```
> "`git log v2.0..master` shows commits reachable from *master* but not *v2.0*" [10]

#### getLabelsOnPR(pr_number)
```
GET /repos/{owner}/{repo}/issues/{issue_number}/labels
```
> "Lists all labels for an issue." [6]

#### getCommentsOnPR(pr_number)
```
GET /repos/{owner}/{repo}/issues/{issue_number}/comments
```
> "List Issue Comments... Path: `/repos/{owner}/{repo}/issues/{issue_number}/comments`" [5]

### setCreate

#### createPullRequest(title, body, head, base)
```
POST /repos/{owner}/{repo}/pulls
```
> "Create a Pull Request... Method: POST, URL Pattern: `/repos/{owner}/{repo}/pulls`" [4]

Or via gh CLI:
```bash
gh pr create --title "..." --body "..." --base main --head branch
```
> "You can use `gh pr create` in a GitHub Actions workflow" [11]

#### createRelease(tag_name, name, body)
```
POST /repos/{owner}/{repo}/releases
```
> "Creating a Release... HTTP Method: POST, URL Pattern: `/repos/{owner}/{repo}/releases`" [3]

#### createComment(pr_number, body)
```
POST /repos/{owner}/{repo}/issues/{issue_number}/comments
```
> "Create an Issue Comment... Method: POST, Path: `/repos/{owner}/{repo}/issues/{issue_number}/comments`" [5]

#### createTag(tag_name, sha)
```bash
git tag {tag_name} {sha}
git push origin {tag_name}
```

#### addLabels(pr_number, labels[])
```
POST /repos/{owner}/{repo}/issues/{issue_number}/labels
```
> "Adding Labels to an Issue... HTTP Method: POST, URL Pattern: `/repos/{owner}/{repo}/issues/{issue_number}/labels`" [6]

### setUpdate

#### updatePullRequest(pr_number, title?, body?)
```
PATCH /repos/{owner}/{repo}/pulls/{pull_number}
```
> "Update a Pull Request... Method: PATCH, URL Pattern: `/repos/{owner}/{repo}/pulls/{pull_number}`" [4]

Or via gh CLI:
```bash
gh pr edit {number} --title "..." --body "..."
```
> "`gh pr edit 23 --title \"I found a bug\" --body \"Nothing works\"`" [11]

#### updateComment(comment_id, body)
```
PATCH /repos/{owner}/{repo}/issues/comments/{comment_id}
```
> "Update an Issue Comment... Method: PATCH, Path: `/repos/{owner}/{repo}/issues/comments/{comment_id}`" [5]

#### updateLabels(pr_number, labels[])
```bash
gh pr edit {number} --add-label "..." --remove-label "..."
```
> "`gh pr edit 23 --add-label \"bug,help wanted\" --remove-label \"core\"`" [11]

### setDelete

#### removeLabels(pr_number)
```
DELETE /repos/{owner}/{repo}/issues/{issue_number}/labels
```
> "Removes all labels from an issue." [6]

---

## Domain Relationships

### Tree Structure of Decoration

```
Release
  â””â”€â”€ Tag (decorated by)
        â””â”€â”€ Commit (points to)

PullRequest
  â”œâ”€â”€ Labels[] (decorated by)
  â”œâ”€â”€ Comments[] (decorated by)
  â””â”€â”€ Commits[] (contains references to)
```

### Tree Structure of Common Subdomains

```
please-release-action
â”œâ”€â”€ subdomain.semver
â”‚     â”œâ”€â”€ parseCommit(message) -> ParsedCommit
â”‚     â”œâ”€â”€ computeBumpType(commits[]) -> 'major' | 'minor' | 'patch'
â”‚     â””â”€â”€ incrementVersion(current, bumpType) -> nextVersion
â”‚
â”œâ”€â”€ subdomain.changelog
â”‚     â”œâ”€â”€ groupCommitsByType(commits[]) -> { feats[], fixes[], breaks[] }
â”‚     â”œâ”€â”€ formatChangelog(grouped, repoUrl) -> markdown
â”‚     â””â”€â”€ extractPRLinks(changelog) -> prNumbers[]
â”‚
â”œâ”€â”€ subdomain.github-pr
â”‚     â”œâ”€â”€ findReleasePR() -> PR | null
â”‚     â”œâ”€â”€ createReleasePR(version, changelog)
â”‚     â”œâ”€â”€ updateReleasePR(pr, version, changelog)
â”‚     â””â”€â”€ commentOnPR(prNumber, message)
â”‚
â””â”€â”€ subdomain.github-release
      â”œâ”€â”€ createTag(version, sha)
      â”œâ”€â”€ createRelease(tag, body)
      â””â”€â”€ getReleaseUrl(tag) -> url
```

### Dependencies

```
scope.upsert-pr
  â”œâ”€â”€ depends on: scope.semver (to compute version)
  â””â”€â”€ depends on: scope.changelog (to generate description)

scope.cut-tag
  â”œâ”€â”€ depends on: scope.changelog (to extract PR links)
  â””â”€â”€ depends on: subdomain.github-release

scope.commitlint
  â””â”€â”€ independent (enforces commit format upstream)
```

---

## Composition to Support Wish

### Flow: Non-Release Commit Merged

```
1. PushEvent triggers workflow
2. getLatestTag() -> currentTag
3. getCommitsSinceTag(currentTag) -> commits[]
4. parseCommits(commits) via conventional-commits-parser
5. computeNextSemver(parsedCommits) via semver.inc()
6. generateChangelog(parsedCommits, repoUrl)
7. getOpenReleasePR() -> existingPR | null
8. IF existingPR:
     - check label uptilCommit matches github.sha
     - IF match: exit (noop)
     - ELSE: updatePullRequest() + updateLabels()
   ELSE:
     - createPullRequest() + addLabels()
```

### Flow: Release Commit Merged

```
1. PushEvent triggers workflow
2. detect commit message starts with "chore(release):"
3. extract version from commit message
4. createTag(version, github.sha)
5. createRelease(tag, changelog)
6. find source release PR (from commit message or search)
7. commentOnPR(releasePR, "ðŸŒŠ released at {url}")
8. extractPRLinks(releasePR.body) -> referencedPRs[]
9. FOR EACH pr in referencedPRs:
     - commentOnPR(pr, "ðŸŒŠ released at {url}")
```

---

## Citations

[1] conventional-commits-parser README - https://github.com/conventional-changelog/conventional-changelog/blob/master/packages/conventional-commits-parser/README.md

[2] Conventional Commits Specification - https://www.conventionalcommits.org/en/v1.0.0/

[3] GitHub REST API Releases - https://docs.github.com/en/rest/releases/releases

[4] GitHub REST API Pull Requests - https://docs.github.com/en/rest/pulls/pulls

[5] GitHub REST API Issue Comments - https://docs.github.com/en/rest/issues/comments

[6] GitHub REST API Labels - https://docs.github.com/en/rest/issues/labels

[7] GitHub Actions Push Event - https://docs.github.com/actions/learn-github-actions/events-that-trigger-workflows

[8] GitHub Actions Commit Message Context - https://www.baeldung.com/ops/github-actions-commit-message

[9] Semantic Versioning - https://semver.org/

[10] Git Log Between Tags - https://www.atlassian.com/git/tutorials/git-log

[11] GitHub CLI gh pr - https://cli.github.com/manual/gh_pr_edit
