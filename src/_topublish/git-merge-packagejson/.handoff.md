# handoff: git-merge-packagejson

## context

this package was developed as a collocated package within `declapract-typescript-ehmpathy`. it is ready for extraction and publication to npm.

**start here:** read `readme.md` — it covers install, setup, behavior, exit codes, and examples.

---

## architecture

```
src/
├── domain.operations/           # leaf operations
│   ├── stripVersionQualifier    # ^1.0.0 → 1.0.0
│   ├── compareVersions          # semver comparison with special version support
│   ├── detectRemovalIntent      # determines if dep was intentionally removed
│   ├── parsePackageJson         # json parse with branch context for errors
│   ├── mergeDependencySection   # merges one dep section (deps, devDeps, etc)
│   └── mergePackageJson         # orchestrates all 4 sections
│
├── contract/commands/
│   ├── merge                    # git merge driver command (exit 0/1/129)
│   └── install                  # configures git with merge driver
│
├── acceptance/                  # 7 usecase acceptance tests
│
└── index.ts                     # public exports
```

---

## test coverage

| type | count | pattern |
|------|-------|---------|
| unit | 6 | `*.test.ts` |
| integration | 1 | `*.integration.test.ts` |
| acceptance | 7 | `*.acceptance.test.ts` |

run tests:
```sh
cd src/_topublish/git-merge-packagejson
npm install
npm test
```

---

## declapract integration

a practice was created at `src/practices/git-merge-packagejson/` that:
1. adds `package.json merge=npm-packagejson-merge` to `.gitattributes`
2. requires `git-merge-packagejson` as a devDependency

this practice is included in `typescript-project` usecase — all ehmpathy typescript projects will auto-adopt it after `declapract apply`.

---

## design decisions

### removal wins over update
if branch A removes a dep and branch B updates it, removal wins. rationale: removal is intentional cleanup; the updater likely didn't know removal was planned.

### ours preferred for incomparable versions
for `latest`, `file:`, `workspace:`, `git+` versions, we can't semver-compare. `ours` is preferred since it's the current branch (what the user merges into).

### no dry-run mode
the merge driver writes directly to `%A` (ours path). git expects this — the driver modifies in place. exit code signals success/conflict.

### exit code semantics
- `0` = fully resolved, git treats merge as success
- `1` = partial resolution, git shows conflict (non-dep fields have markers)
- `>128` = error (git convention for driver failures)

---

## pre-publish checklist

- [ ] update `package.json` version
- [ ] ensure `bin/git-merge-packagejson.js` shebang is correct
- [ ] verify `main`, `types`, `files` fields in package.json
- [ ] run full test suite
- [ ] test cli manually: `npx . --install` and simulate a merge
- [ ] update readme if needed
- [ ] publish: `npm publish`

---

## known limitations

1. **no lockfile merge** — only handles `package.json`, not `package-lock.json` or `pnpm-lock.yaml`
2. **no nested package.json** — assumes root package.json only (git attributes can be extended)
3. **json output format** — uses 2-space indent; doesn't preserve original format style

---

## future work

- [ ] add `--uninstall` command to remove git config
- [ ] add `--check` command to verify setup is correct
- [ ] consider lockfile merge support (complex — different formats)
- [ ] add verbose mode for debug output

---

## origin

developed in: `declapract-typescript-ehmpathy` on branch `vlad/git-merge-autoresolve`

behavior spec: `.behavior/v2026_01_17.git-merge-packagejson-autoresolve/`
