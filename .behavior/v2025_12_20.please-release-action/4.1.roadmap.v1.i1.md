# Roadmap: please-release-action

## Overview

Execute the blueprint to replace `google-github-actions/release-please-action` with a custom collocated composite action.

---

## Phase 1: Implement Core Action

### 1.1 Create composite action skeleton

**file:** `src/practices/cicd-common/best-practice/.github/actions/please-release/action.yml`

**depends on:** nothing

- [ ] create action.yml with inputs (github-token, commit-message, commit-sha, repository)
- [ ] create action.yml with outputs (action, version, pr-number)
- [ ] define 4 step stubs with correct `if` conditions and `env` vars

**acceptance criteria:**
- scope.cut-tag.usecase.no-loop: step 1 runs only for release commits, steps 2-4 run only for non-release commits

**verification:**
```bash
# syntax check
cat src/practices/cicd-common/best-practice/.github/actions/please-release/action.yml | yq .
```

---

### 1.2 Implement step 1: cutta tag

**file:** `src/practices/cicd-common/best-practice/.github/actions/please-release/action.yml`

**depends on:** 1.1

- [ ] detect release commit via `chore(release):` prefix
- [ ] extract version from commit message
- [ ] failfast if version not found
- [ ] find merged release PR by title search
- [ ] failfast if release PR not found
- [ ] failfast if release PR missing `release={version}` label
- [ ] create and push git tag
- [ ] create github release with `--generate-notes`
- [ ] comment on release PR with release url
- [ ] extract referenced PRs from body and comment on each
- [ ] output `did-cutta=true/false`

**acceptance criteria:**
- scope.cut-tag.usecase.release-commit: git tag and github release created
- scope.cut-tag.usecase.comment-release-pr: comment added to release PR
- scope.cut-tag.usecase.comment-referenced-prs: comment added to each referenced PR

**verification:**
```bash
# manual test: merge a release PR, verify tag + release + comments created
gh run list --workflow=release.yml --limit=1
gh release view <version>
gh pr view <pr-number> --comments
```

---

### 1.3 Implement step 2: crunch future semver

**file:** `src/practices/cicd-common/best-practice/.github/actions/please-release/action.yml`

**depends on:** 1.1

- [ ] get latest tag via `git describe --tags --abbrev=0`
- [ ] early return `v0.1.0` if no tags exist
- [ ] get commits since tag
- [ ] detect `break:` commits for major bump
- [ ] detect `feat:` commits for minor bump
- [ ] default to patch bump
- [ ] compute next version string
- [ ] output `next-version`

**acceptance criteria:**
- scope.semver.usecase.patch: fix commits bump patch
- scope.semver.usecase.minor: feat commits bump minor
- scope.semver.usecase.major: break commits bump major
- scope.semver.usecase.precedence: major > minor > patch
- scope.semver.usecase.first-release: no tags means v0.1.0
- scope.semver.usecase.default-patch: non-conventional commits default to patch

**verification:**
```bash
# unit test scenarios (manual)
# scenario 1: repo with v1.2.3 tag, only fix commits -> expect v1.2.4
# scenario 2: repo with v1.2.3 tag, has feat commit -> expect v1.3.0
# scenario 3: repo with v1.2.3 tag, has break commit -> expect v2.0.0
# scenario 4: repo with no tags -> expect v0.1.0
```

---

### 1.4 Implement step 3: crunch future changelog

**file:** `src/practices/cicd-common/best-practice/.github/actions/please-release/action.yml`

**depends on:** 1.3

- [ ] group commits by type (breaks, feats, fixes)
- [ ] format header with compare link and date
- [ ] format each commit as tree with date, PR link (if present), commit link
- [ ] output changelog string

**acceptance criteria:**
- scope.changelog.usecase.grouping: commits grouped under `### breaks`, `### feats`, `### fixes`
- scope.changelog.usecase.pr-links: PR references converted to full links
- scope.changelog.usecase.commit-links: commit hashes converted to full links
- scope.changelog.usecase.header: header includes compare link and release date

**verification:**
```bash
# manual test: inspect PR body after workflow runs
gh pr view <pr-number> --json body --jq '.body'
# verify: header has compare link
# verify: commits grouped by type
# verify: each commit has tree structure with date, pr link, commit link
```

---

### 1.5 Implement step 4: upsert release pr

**file:** `src/practices/cicd-common/best-practice/.github/actions/please-release/action.yml`

**depends on:** 1.3, 1.4

- [ ] failfast if package.json not found
- [ ] find existing release PR by `purpose=release` label
- [ ] if exists: fetch branch, update package.json, commit, push, update PR metadata
- [ ] if not exists: create branch, update package.json, commit, push, create PR
- [ ] apply labels: `purpose=release`, `release={version}`

**acceptance criteria:**
- scope.upsert-pr.usecase.create: new PR created with correct labels, title, description
- scope.upsert-pr.usecase.update: existing PR updated with new version and changelog
- scope.upsert-pr.usecase.description-format: description starts with intro line, has hr, has changelog

**verification:**
```bash
# scenario 1: no open release PR -> new PR created
gh pr list --state open --label "purpose=release"
# verify: PR exists with correct title, labels, body format

# scenario 2: open release PR exists -> PR updated
# merge another commit, verify PR title/body/labels updated
```

---

### 1.6 Update release.yml workflow

**file:** `src/practices/cicd-common/best-practice/.github/workflows/release.yml`

**depends on:** 1.5

- [ ] get github app token first (before checkout)
- [ ] checkout with token for git push auth
- [ ] call composite action with all inputs

**acceptance criteria:**
- workflow calls composite action instead of release-please-action
- git push operations authenticated with app token
- gh cli operations authenticated with GITHUB_TOKEN env

**verification:**
```bash
# diff the workflow
diff src/practices/cicd-common/best-practice/.github/workflows/release.yml <old-version>
# verify: no reference to google-github-actions/release-please-action
# verify: uses ./.github/actions/please-release
```

---

## Phase 2: Implement Supporting Changes

### 2.1 Update commitlint config

**file:** `src/practices/commits/best-practice/commitlint.config.cjs`

**depends on:** nothing

- [ ] add `break` to type-enum
- [ ] add rule to forbid `!` prefix via `subject-exclamation-mark`

**acceptance criteria:**
- scope.commitlint.usecase.allow-break: `break:` and `break(scope):` commits accepted
- scope.commitlint.usecase.forbid-legacy-breaking: `feat!:` commits rejected

**verification:**
```bash
# test valid commit
echo "break(api): remove deprecated endpoint" | npx commitlint --verbose
# expect: pass

# test invalid commit
echo "feat!: add new feature" | npx commitlint --verbose
# expect: fail
```

---

### 2.2 Add bad practice for changelog.md

**file:** `src/practices/cicd-common/bad-practices/has-changelog-file/changelog.md.declapract.ts`

**depends on:** nothing

- [ ] create check that matches if changelog.md exists
- [ ] create fix that returns `{ contents: null }` to delete file

**acceptance criteria:**
- repos with changelog.md are flagged by declapract
- fix deletes the changelog.md file

**verification:**
```bash
# run declapract check against a repo with changelog.md
npx declapract check --use-case lambda
# expect: changelog.md flagged

# run declapract apply
npx declapract apply --use-case lambda
# expect: changelog.md deleted
```

---

## Phase 3: Validate

### 3.1 Test in this repo

**depends on:** 1.6, 2.1, 2.2

- [ ] copy action and workflow to this repo's .github
- [ ] merge a feat commit, verify release PR created
- [ ] merge another fix commit, verify release PR updated
- [ ] merge the release PR, verify tag and release created
- [ ] verify comments added to release PR and referenced PRs

**acceptance criteria:**
- all scope.* criteria from 2.criteria.md pass

**verification:**
```bash
# measure speed
gh run view <run-id> --json jobs --jq '.jobs[0].steps[] | select(.name == "please release") | .duration'
# expect: <5s (vs previous ~30s)
```

---

### 3.2 Test edge cases

**depends on:** 3.1

- [ ] test first release (no existing tags)
- [ ] test break: commit (major bump)
- [ ] test mixed commit types (precedence)
- [ ] test commit without PR reference

**acceptance criteria:**
- scope.semver.usecase.first-release: v0.1.0 for new repos
- scope.semver.usecase.precedence: major > minor > patch

**verification:**
```bash
# create test repo with no tags
# merge feat commit
# verify: PR shows v0.1.0
```

---

## Phase 4: Roll Out

### 4.1 Run declapract apply

**depends on:** 3.2

- [ ] run `npx declapract apply` against ehmpathy repos
- [ ] verify composite action copied to each repo
- [ ] verify workflow updated in each repo
- [ ] verify changelog.md flagged for deletion

**acceptance criteria:**
- old release-please-action pattern replaced automatically
- all repos have new please-release action

**verification:**
```bash
# for each repo
gh search code "release-please-action" --owner ehmpathy
# expect: no results (old action removed)

gh search code "please-release" --owner ehmpathy
# expect: results in .github/actions/please-release
```

---

## Dependency Graph

```
1.1 (skeleton)
 ├── 1.2 (cutta tag)
 ├── 1.3 (semver)
 │    └── 1.4 (changelog)
 │         └── 1.5 (upsert pr)
 │              └── 1.6 (workflow)
 │                   └── 3.1 (test in repo)
 │                        └── 3.2 (edge cases)
 │                             └── 4.1 (roll out)
 │
2.1 (commitlint) ─────────────────┘
2.2 (bad practice changelog.md) ──┘
```

---

## Success Criteria

- [ ] release workflow completes in <5s (vs current ~30s)
- [ ] PR title/body format matches specification exactly
- [ ] all scope.* criteria from 2.criteria.md pass
- [ ] no manual post-processing steps needed
- [ ] clean migration path for existing repos
