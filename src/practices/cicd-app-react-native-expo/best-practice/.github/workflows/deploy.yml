name: deploy

on:
  push:
    tags:
      - v*
    branches:
      - 'main'
      - 'master'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }} # per [workflow] x [branch, tag]
  cancel-in-progress: true # only cancel work flows on non-latest commits

jobs:
  test:
    uses: ./.github/workflows/.test.yml
    with:
      aws-region: us-east-1
      aws-account-id: '@declapract{variable.awsAccountId.dev}'
    secrets:
      aws-access-key-id: ${{ secrets.DEV_AWS_ACCESS_KEY_ID }}
      aws-secret-access-key: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}

  # todo: start deploying dev builds for testing... want to be smart regarding how often we do this though -> e.g., no need to waste builds ($3 per build)
  # dev:
  #   uses: ./.github/workflows/.deploy-expo.yml
  #   if: github.ref == 'refs/heads/main' &&  !contains(github.event.head_commit.message, 'chore(release)')
  #   needs: [test]
  #   with:
  #     stage: dev
  #     build: development
  #     github-environment: dev
  #     aws-region: us-east-1
  #     aws-account-id: '@declapract{variable.awsAccountId.dev}'
  #   secrets:
  #     expo-token: ${{ secrets.EXPO_TOKEN }}
  #     aws-access-key-id: ${{ secrets.DEV_AWS_ACCESS_KEY_ID }}
  #     aws-secret-access-key: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}

  prod:
    uses: ./.github/workflows/.deploy-expo.yml
    if: startsWith(github.ref, 'refs/tags/')
    needs: [test]
    with:
      stage: prod
      build: production
      github-environment: prod
      aws-region: us-east-1
      aws-account-id: '@declapract{variable.awsAccountId.prod}'
      app-web-deployment-s3-bucket: s3://@declapract{variable.projectName}-@declapract{variable.infrastructureNamespaceId}-prod'
    secrets:
      expo-token: ${{ secrets.EXPO_TOKEN }}
      aws-access-key-id: ${{ secrets.PROD_AWS_ACCESS_KEY_ID }}
      aws-secret-access-key: ${{ secrets.PROD_AWS_SECRET_ACCESS_KEY }}
