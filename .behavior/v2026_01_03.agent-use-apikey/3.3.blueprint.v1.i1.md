# blueprint: agent-use-apikey

## overview

standardize api key management for agents across all ehmpathy typescript projects via declapract best practices.

## domain distillation

### .what
agents must be able to source api keys for integration and acceptance tests without manual intervention or confusion about credential availability.

### .why
agents often give up when tests fail due to absent api keys, even when they have access to credentials. this creates friction and wasted cycles.

### .how
1. standardize presence of `use.apikeys.sh` skill
2. declare required api keys in `use.apikeys.json`
3. validate api keys in jest env files with agent-friendly error messages

---

## implementation plan

### phase 1: add apikeys practice files to `tests` practice

#### 1.1 create best-practice files for apikeys skill

location: `src/practices/tests/best-practice/`

##### file: `.agent/repo=.this/role=any/skills/use.apikeys.sh`

```sh
#!/usr/bin/env bash
######################################################################
# .what = export api keys for integration tests
# .why = enables running integration tests that require api keys
#
# usage:
#   source .agent/repo=.this/role=any/skills/use.apikeys.sh
#
# note:
#   - must be called with `source` to export vars to current shell
#   - loads from ~/.config/rhachet/apikeys.env if available
#   - falls back to .env.local (gitignored) in repo root
######################################################################

# fail if not sourced
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  echo "error: this script must be sourced, not executed"
  echo "usage: source ${BASH_SOURCE[0]}"
  exit 1
fi

# try loading from user config first
if [[ -f ~/.config/rhachet/apikeys.env ]]; then
  source ~/.config/rhachet/apikeys.env
  echo "✓ loaded api keys from ~/.config/rhachet/apikeys.env"

# fallback to local gitignored file
elif [[ -f .env.local ]]; then
  source .env.local
  echo "✓ loaded api keys from .env.local"

else
  echo "⚠ no api keys file found"
  echo ""
  echo "create one of:"
  echo "  ~/.config/rhachet/apikeys.env"
  echo "  .env.local (in repo root)"
  echo ""
  echo "with contents like:"
  echo "  export OPENAI_API_KEY=sk-..."
  echo "  export ANTHROPIC_API_KEY=sk-..."
  return 1
fi

# read required keys from json config if present
APIKEYS_CONFIG=".agent/repo=.this/role=any/skills/use.apikeys.json"
if [[ -f "$APIKEYS_CONFIG" ]]; then
  # extract required keys using jq
  REQUIRED_KEYS=$(jq -r '.apikeys.required[]?' "$APIKEYS_CONFIG" 2>/dev/null)

  # verify each required key is set
  for KEY in $REQUIRED_KEYS; do
    if [[ -z "${!KEY}" ]]; then
      echo "⚠ $KEY not set (required by $APIKEYS_CONFIG)"
      return 1
    fi
    echo "✓ $KEY set"
  done
fi
```

##### file: `.agent/repo=.this/role=any/skills/use.apikeys.json`

```json
{
  "apikeys": {
    "required": []
  }
}
```

##### file: `.agent/repo=.this/role=any/skills/use.apikeys.json.declapract.ts`

```typescript
import { FileCheckType } from 'declapract';

// check that the file exists; contents are user-defined
export const check = FileCheckType.EXISTS;
```

##### file: `.agent/repo=.this/role=any/skills/use.apikeys.sh.declapract.ts`

```typescript
import { FileCheckType } from 'declapract';

// check that the file contains the core structure
export const check = FileCheckType.CONTAINS;
```

---

### phase 2: update jest env files to validate api keys

#### 2.1 update jest.integration.env.ts

add to existing file after aws credential validation:

```typescript
// validate api keys from use.apikeys.json
const apikeysConfigPath = join(
  process.cwd(),
  '.agent/repo=.this/role=any/skills/use.apikeys.json',
);
if (existsSync(apikeysConfigPath)) {
  // direct import via require (json resolves automatically)
  const config = require(apikeysConfigPath);
  const requiredKeys: string[] = config?.apikeys?.required ?? [];
  const keysAbsent = requiredKeys.filter((key) => !process.env[key]);

  if (keysAbsent.length > 0) {
    throw new Error(`
⛈️  apikeys required to run these integration tests were not supplied.

   absent keys: ${keysAbsent.join(', ')}

   you have access to these keys - you just forgot to source them.

   run:
     source .agent/repo=.this/role=any/skills/use.apikeys.sh && npm run test:integration

   you must run these tests with these api keys.
   you're forbidden to give up. you can and must run the test yourself.
   if you don't have privs to run use.apikeys.sh, ask a human for support.
   chances are, you already have privs to do so though.
`);
  }
}
```

#### 2.2 update jest.acceptance.env.ts

add same validation block with `test:acceptance` in the run command.

---

### phase 3: test coverage

#### 3.1 unit tests

| file                                                                | tests                                                                                                                                          |
| ------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| `src/practices/tests/best-practice/jest.apikeys.validation.test.ts` | - passes when all keys present<br>- throws when keys absent<br>- error message contains absent keys<br>- error message contains source command |

#### 3.2 acceptance tests

| scenario                                                          | test                                    |
| ----------------------------------------------------------------- | --------------------------------------- |
| `npm run test` against repo with empty apikeys.json               | should pass                             |
| `npm run test:integration` against repo with required keys absent | should fail with agent-friendly message |
| `npm run test:acceptance` against repo with required keys absent  | should fail with agent-friendly message |
| `npm run test:integration` after sourcing keys                    | should pass                             |

---

## file manifest

### new files

| path                                                                                                 | purpose                         |
| ---------------------------------------------------------------------------------------------------- | ------------------------------- |
| `src/practices/tests/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.sh`                 | shell script to source api keys |
| `src/practices/tests/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.sh.declapract.ts`   | check for shell script presence |
| `src/practices/tests/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.json`               | config declaring required keys  |
| `src/practices/tests/best-practice/.agent/repo=.this/role=any/skills/use.apikeys.json.declapract.ts` | check for json presence         |

### modified files

| path                                                        | change                 |
| ----------------------------------------------------------- | ---------------------- |
| `src/practices/tests/best-practice/jest.integration.env.ts` | add api key validation |
| `src/practices/tests/best-practice/jest.acceptance.env.ts`  | add api key validation |

---

## dependencies

no new dependencies required. uses:
- `fs` (node built-in)
- `path` (node built-in)
- `require()` for json import (node built-in)

---

## rollout

1. implement in declapract-typescript-ehmpathy
2. run `npm run test` to verify all tests pass
3. publish new version
4. run `npx declapract apply` in target repos to propagate changes
5. users add their required keys to `use.apikeys.json`
